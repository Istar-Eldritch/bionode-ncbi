<!DOCTYPE html>

<html>
<head>
  <title>bionode-ncbi</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="bionode-ncbi">bionode-ncbi</h1>
<blockquote>
<p>Node.js module for working with the NCBI API (aka e-utils) using Streams.</p>
<p>doi: <a href="http://dx.doi.org/10.5281/zenodo.10610">10.5281/zenodo.10610</a>
author: <a href="http://bmpvieira.com">Bruno Vieira</a>
email: <a href="&#x6d;&#x61;&#x69;&#x6c;&#116;&#x6f;&#x3a;&#109;&#x61;&#105;&#108;&#x40;&#98;&#109;&#112;&#x76;&#x69;&#x65;&#105;&#114;&#97;&#46;&#99;&#x6f;&#109;">&#109;&#x61;&#105;&#108;&#x40;&#98;&#109;&#112;&#x76;&#x69;&#x65;&#105;&#114;&#97;&#46;&#99;&#x6f;&#109;</a>
license: <a href="https://raw.githubusercontent.com/bionode/bionode-ncbi/master/LICENSE">MIT</a></p>
</blockquote>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="usage">Usage</h2>
<p>This module can be used in Node.js as described further below, or as a command line tool.
Examples:</p>
<pre><code>$ npm install -g bionode-ncbi

# bionode-ncbi [command] [<span class="hljs-built_in">arguments</span>]
$ bionode-ncbi search taxonomy solenopsis
$ bionode-ncbi download assembly solenopsis invicta
$ bionode-ncbi urls sra solenopsis invicta
$ bionode-ncbi link assembly bioproject <span class="hljs-number">244018</span>
$ bionode-ncbi search gds solenopsis | dat import --json
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">var</span> mkdirp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mkdirp'</span>)
<span class="hljs-keyword">var</span> async = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
<span class="hljs-keyword">var</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>)
<span class="hljs-keyword">var</span> through = <span class="hljs-built_in">require</span>(<span class="hljs-string">'through2'</span>)
<span class="hljs-keyword">var</span> JSONStream = <span class="hljs-built_in">require</span>(<span class="hljs-string">'JSONStream'</span>)
<span class="hljs-keyword">var</span> xml2js = <span class="hljs-built_in">require</span>(<span class="hljs-string">'xml2js'</span>).parseString
<span class="hljs-keyword">var</span> dld = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dld'</span>)
<span class="hljs-keyword">var</span> tool = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tool-stream'</span>)
<span class="hljs-keyword">var</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'bionode-ncbi'</span>)


<span class="hljs-built_in">module</span>.exports = exports = ncbi = <span class="hljs-keyword">new</span> NCBI()

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NCBI</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.APIROOT = <span class="hljs-string">'http://eutils.ncbi.nlm.nih.gov/entrez/eutils/'</span>
  <span class="hljs-keyword">this</span>.DEFAULTS = <span class="hljs-string">'retmode=json&amp;version=2.0'</span>
  <span class="hljs-keyword">this</span>.RETURNMAX = <span class="hljs-number">250</span>
  <span class="hljs-keyword">this</span>.XMLPROPERTIES = {
    <span class="hljs-string">'sra'</span>: [<span class="hljs-string">'expxml'</span>, <span class="hljs-string">'runs'</span>],
    <span class="hljs-string">'biosample'</span>: [<span class="hljs-string">'sampledata'</span>],
    <span class="hljs-string">'assembly'</span>: [<span class="hljs-string">'meta'</span> ]
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="search">Search</h2>
<p>Takes a NCBI database string and a optional search term and returns a stream of objects found:</p>
<pre><code>ncbi.search('sra', 'solenopsis').on('data', console.log)
=&gt; { uid: '280116',
     expxml: {"Summary":{"Title":"Single Solenopsis invicta male","Platform":{"_":"ILLUMINA", [...],
     runs: {"Run":[{"acc":"SRR620577","total_spots":"23699662","total_bases":"4787331724", [...],
     extlinks: '    ',
     createdate: '2013/02/07',
     updatedate: '2012/11/28' }
=&gt; { uid: '280243',
     expxml: {"Summary":{"Title":"Illumina small-insert paired end","Platform":{"_":"ILLUMINA", [...],
     runs: {"Run":[{"acc":"SRR621118","total_spots":"343209818","total_bases":"34320981800", [...],
     extlinks: '    ',
     createdate: '2013/02/07,
     updatedate: '2012/11/28' }
=&gt; [...]
</code></pre><p>The search term can also be passed with write:</p>
<pre><code><span class="hljs-keyword">var</span> search = ncbi.search(<span class="hljs-string">'sra'</span>).on(<span class="hljs-string">'data'</span>, <span class="hljs-built_in">console</span>.log)
search.write(<span class="hljs-string">'solenopsis'</span>)
</code></pre><p>Or piped, for example, from a file:</p>
<pre><code><span class="hljs-keyword">var</span> split = <span class="hljs-built_in">require</span>(<span class="hljs-string">'split'</span>)

fs.createReadStream(<span class="hljs-string">'searchTerms.txt'</span>)
.pipe(split())
.pipe(search)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
NCBI.prototype.search = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(db, term)</span> </span>{
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">if</span> (term) { stream.write(term); stream.end() }
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(obj, enc, next)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> query = [
      ncbi.APIROOT + <span class="hljs-string">'esearch.fcgi?'</span>,
      ncbi.DEFAULTS,
      <span class="hljs-string">'db='</span> + db,
      <span class="hljs-string">'term='</span> + <span class="hljs-built_in">encodeURI</span>(obj),
      <span class="hljs-string">'usehistory=y'</span>
    ].join(<span class="hljs-string">'&amp;'</span>)

    <span class="hljs-keyword">var</span> getUIDs = _requestData(db)

    debug(<span class="hljs-string">'esearch request'</span>, query)

    <span class="hljs-keyword">var</span> req = request({ uri: query, json: <span class="hljs-literal">true</span> })

    req.on(<span class="hljs-string">'response'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resp)</span> </span>{
      debug(<span class="hljs-string">'esearch response'</span>, resp.statusCode)
    })

    req
    .pipe(JSONStream.parse())
    .pipe(_requestsSplit(db))
    .pipe(getUIDs)

    _attachStandardEvents(getUIDs, self, next)
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_requestsSplit</span><span class="hljs-params">(db)</span> </span>{
  <span class="hljs-keyword">return</span> through.obj(transform)
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(obj, enc, next)</span> </span>{
    debug(<span class="hljs-string">'esearch results'</span>, obj)
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> webenv = obj.esearchresult.webenv
    <span class="hljs-keyword">var</span> count = obj.esearchresult.count
    <span class="hljs-keyword">var</span> numRequests = <span class="hljs-built_in">Math</span>.floor(count / ncbi.RETURNMAX)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt;= numRequests; i++) {
      <span class="hljs-keyword">var</span> start = { db: db, webenv: webenv, retstart: i * ncbi.RETURNMAX }
      self.push(start)
    }
    next()
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_requestData</span><span class="hljs-params">(db)</span> </span>{
  <span class="hljs-keyword">return</span> through.obj(transform)
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(obj, enc, next)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> query = [
      ncbi.APIROOT + <span class="hljs-string">'esummary.fcgi?'</span>,
      ncbi.DEFAULTS,
      <span class="hljs-string">'db='</span> + obj.db,
      <span class="hljs-string">'query_key=1'</span>,
      <span class="hljs-string">'WebEnv='</span> + obj.webenv,
      <span class="hljs-string">'retmax='</span> + ncbi.RETURNMAX,
      <span class="hljs-string">'retstart='</span> + obj.retstart
    ].join(<span class="hljs-string">'&amp;'</span>)
    <span class="hljs-keyword">var</span> xmlProperties = ncbi.XMLPROPERTIES[db] || []

    <span class="hljs-keyword">var</span> finish = through.obj()
    <span class="hljs-keyword">if</span> (db === <span class="hljs-string">'sra'</span>) {
      <span class="hljs-keyword">var</span> sraFinish = tool.filterObjectsArray(<span class="hljs-string">'total_bases'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'runs.Run'</span>)
      _attachStandardEvents(sraFinish, self, next)
      finish
      .pipe(tool.ensureIsArray(<span class="hljs-string">'runs.Run'</span>))
      .pipe(sraFinish)
    }
    <span class="hljs-keyword">else</span> {
      _attachStandardEvents(finish, self, next)
    }

    debug(<span class="hljs-string">'esummary request'</span>, query)

    <span class="hljs-keyword">var</span> req = request({uri: query, json: <span class="hljs-literal">true</span>})

    req.on(<span class="hljs-string">'response'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resp)</span> </span>{
      debug(<span class="hljs-string">'esummary response'</span>, resp.statusCode)
    })

    req
    .pipe(JSONStream.parse())
    .pipe(tool.extractProperty(<span class="hljs-string">'result'</span>))
    .pipe(tool.deleteProperty(<span class="hljs-string">'uids'</span>))
    .pipe(tool.arraySplit())
    .pipe(tool.XMLToJSProperties(xmlProperties))
    .pipe(finish)
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="link">Link</h2>
<p>Takes a string for source NCBI database and another for destination db and returns
a objects stream with unique IDs linked to the passed source db unique ID.</p>
<pre><code>ncbi.link(<span class="hljs-string">'taxonomy'</span>, <span class="hljs-string">'sra'</span>, <span class="hljs-number">443821</span>)
=&gt; { <span class="hljs-string">"srcDB"</span>:<span class="hljs-string">"taxonomy"</span>,
     <span class="hljs-string">"destDB"</span>:<span class="hljs-string">"sra"</span>,
     <span class="hljs-string">"srcUID"</span>:<span class="hljs-string">"443821"</span>,
     <span class="hljs-string">"destUID"</span>:<span class="hljs-string">"677548"</span> }
=&gt; { <span class="hljs-string">"srcDB"</span>:<span class="hljs-string">"taxonomy"</span>,
     <span class="hljs-string">"destDB"</span>:<span class="hljs-string">"sra"</span>,
     <span class="hljs-string">"srcUID"</span>:<span class="hljs-string">"443821"</span>,
     <span class="hljs-string">"destUID"</span>:<span class="hljs-string">"677547"</span> }
=&gt; [...]
</code></pre><p>Also works with write and pipe, like <strong>Search</strong>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
NCBI.prototype.link = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(srcDB, destDB, srcUID)</span> </span>{
  <span class="hljs-keyword">var</span> stream = through.obj(getDestUID)
  <span class="hljs-keyword">if</span> (srcUID) { stream.write(srcUID); stream.end() }
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDestUID</span><span class="hljs-params">(srcUID, enc, next)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> query = [
      ncbi.APIROOT + <span class="hljs-string">'elink.fcgi?'</span>,
      <span class="hljs-string">'dbfrom='</span> + srcDB,
      <span class="hljs-string">'db='</span> + destDB,
      <span class="hljs-string">'id='</span> + srcUID
    ].join(<span class="hljs-string">'&amp;'</span>)

    <span class="hljs-keyword">var</span> link = {
      srcDB: srcDB,
      destDB: destDB,
      srcUID: srcUID
    }

    <span class="hljs-keyword">var</span> linkName = srcDB+<span class="hljs-string">'_'</span>+destDB

    <span class="hljs-keyword">var</span> getLink = tool.attachToObject(link, <span class="hljs-string">'destUID'</span>)

    debug(<span class="hljs-string">'elink request'</span>, query)

    request({ uri: query, json: <span class="hljs-literal">true</span> })
    .pipe(_wait(<span class="hljs-number">500</span>))
    .pipe(tool.XMLToJS(<span class="hljs-literal">true</span>))
    .pipe(tool.extractProperty(<span class="hljs-string">'LinkSet.0.LinkSetDb'</span>))
    .pipe(tool.arraySplit())
    .pipe(tool.collectMatch(<span class="hljs-string">'LinkName.0'</span>, linkName))
    .pipe(tool.extractProperty(<span class="hljs-string">'Link'</span>))
    .pipe(tool.arraySplit())
    .pipe(tool.extractProperty(<span class="hljs-string">'Id.0'</span>))
    .pipe(getLink)
    _attachStandardEvents(getLink, self, next)
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="download">Download</h2>
<p>Takes a NCBI database string and a optional search term and downloads the datasets/sequence files.
<strong> Currently only supports sra and assembly databases. </strong>
Also accepts the keyword gff for annotations.
Returns a stream that emits download progress and ends with download path
The name of the folder where the file is saved corresponds to the UID from NCBI.</p>
<pre><code>ncbi.download('assembly', 'solenopsis invicta')
.on('data', console.log)
.on('end', function(path) {
  console.log('File saved at ' + path)
}
=&gt; Downloading 244018/unplaced.scaf.fa.gz 0.94 % of 106 MB at 0.48 MB/s
=&gt; Downloading 244018/unplaced.scaf.fa.gz 100.00 % of 106 MB at 0.49 MB/s"
=&gt; File saved at 244018/unplaced.scaf.fa.gz
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
NCBI.prototype.download = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(db, term)</span> </span>{
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">if</span> (term) { stream.write(term); stream.end() }
  <span class="hljs-keyword">return</span> stream
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(obj, enc, next)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> download = _download()
    <span class="hljs-keyword">var</span> searchdb = db === <span class="hljs-string">'gff'</span> ? <span class="hljs-string">'genome'</span> : db
    <span class="hljs-keyword">var</span> getdb = db

    ncbi.search(searchdb, obj)
    .pipe(_getURLs(getdb))
    .pipe(download)
    _attachStandardEvents(download, self, next)
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="urls">URLs</h2>
<p>Takes a NCBI database string and a optional search term and returns as stream of dataset/sequence files URLs.
<strong> Currently only supports sra and assembly databases. </strong>
Also accepts the keyword gff for annotations.
The value of the uid property corresponds to the UID from NCBI.</p>
<pre><code>ncbi.urls(<span class="hljs-string">'assembly'</span>, <span class="hljs-string">'solenopsis invicta'</span>)
.on(<span class="hljs-string">'data'</span>, <span class="hljs-built_in">console</span>.log)
=&gt; {<span class="hljs-string">"url"</span>:<span class="hljs-string">"http://ftp.ncbi.nlm.nih.gov/genbank/genomes/Eukaryotes/invertebrates/Solenopsis_invicta/Si_gnG/Primary_Assembly/unplaced_scaffolds/FASTA/unplaced.scaf.fa.gz"</span>,
    <span class="hljs-string">"uid"</span>:<span class="hljs-string">"244018/"</span>}
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
NCBI.prototype.urls = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(db, term)</span> </span>{
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">if</span> (term) { stream.write(term); stream.end() }
  <span class="hljs-keyword">return</span> stream
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(obj, enc, next)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> searchdb = db === <span class="hljs-string">'gff'</span> ? <span class="hljs-string">'genome'</span> : db
    <span class="hljs-keyword">var</span> getdb = db
    <span class="hljs-keyword">var</span> getURLs = _getURLs(getdb)
    ncbi.search(searchdb, obj)
    .pipe(getURLs)
    _attachStandardEvents(getURLs, self, next)
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_getURLs</span><span class="hljs-params">(db)</span> </span>{
  <span class="hljs-keyword">return</span> through.obj(transform)
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(obj, enc, next)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> parseURL = {
      sra: sraURL,
      assembly: assemblyURLFromEBI,
      gff: gffURL
    }

    parseURL[db]()

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sraURL</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> runs = obj.runs.Run
      async.eachSeries(runs, printSRAURL, next)
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printSRAURL</span><span class="hljs-params">(run, cb)</span> </span>{
        <span class="hljs-keyword">var</span> acc = run.acc
        <span class="hljs-keyword">var</span> runURL = [
          <span class="hljs-string">'http://ftp.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByRun/sra/'</span>,
          acc.slice(<span class="hljs-number">0</span>,<span class="hljs-number">3</span>) + <span class="hljs-string">'/'</span>,
          acc.slice(<span class="hljs-number">0</span>,<span class="hljs-number">6</span>) + <span class="hljs-string">'/'</span>,
          acc + <span class="hljs-string">'/'</span>,
          acc + <span class="hljs-string">'.sra'</span>,
        ].join(<span class="hljs-string">''</span>)
        self.push({url: runURL, uid: obj.uid})
        cb()
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>NCBI API started returning wrong FTP URLs
See: <a href="https://medium.com/@bmpvieira/when-bioinformatics-apis-break-821ae9919492">https://medium.com/@bmpvieira/when-bioinformatics-apis-break-821ae9919492</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">assemblyURL</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span> (obj.meta.FtpSites) {
        <span class="hljs-keyword">var</span> ftpPath = obj.meta.FtpSites.FtpPath
        <span class="hljs-keyword">var</span> ftpArray = <span class="hljs-built_in">Array</span>.isArray(ftpPath) ? ftpPath : [ ftpPath ]
        ftpArray.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ftp)</span> </span>{
          <span class="hljs-keyword">var</span> assemblyURL = ftp._.replace(<span class="hljs-string">'ftp://'</span>, <span class="hljs-string">'http://'</span>) + <span class="hljs-string">'/Primary_Assembly/unplaced_scaffolds/FASTA/unplaced.scaf.fa.gz'</span>
          self.push({url: assemblyURL, uid: obj.uid})
        })
      }
      next()
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>HACK: Get assembly fasta URLs from EBI. Should be moved to bionode-ebi.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">assemblyURLFromEBI</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span> (obj.wgs) {
        <span class="hljs-keyword">var</span> accession = obj.wgs.slice(<span class="hljs-number">0</span>,<span class="hljs-number">4</span>).toLowerCase()
        <span class="hljs-keyword">var</span> assemblyURL = <span class="hljs-string">'http://ftp.ebi.ac.uk/pub/databases/fastafiles/embl_genomes/wgs/'</span> + accession + <span class="hljs-string">'.wgs.gz'</span>
        self.push({url: assemblyURL, uid: obj.uid})
      }
      next()
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gffURL</span><span class="hljs-params">()</span> </span>{
      ncbi.search(<span class="hljs-string">'assembly'</span>, obj.assembly_name).on(<span class="hljs-string">'data'</span>, createURL)
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createURL</span><span class="hljs-params">(obj)</span> </span>{
        debug(<span class="hljs-string">'gffURL result'</span>, obj)
        <span class="hljs-keyword">var</span> gffURL
        <span class="hljs-keyword">var</span> ftpPath = obj.meta.FtpSites.FtpPath
        <span class="hljs-keyword">var</span> ftpArray = <span class="hljs-built_in">Array</span>.isArray(ftpPath) ? ftpPath : [ ftpPath ]
        ftpArray.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ftp)</span> </span>{
          <span class="hljs-keyword">if</span> (ftp.type === <span class="hljs-string">'RefSeq'</span>) {
            gffURL = ftp._.replace(<span class="hljs-string">'ftp://'</span>, <span class="hljs-string">'http://'</span>) + <span class="hljs-string">'GFF/ref_'</span> + obj.assemblyname + <span class="hljs-string">'_top_level.gff3.gz'</span>
          }
        })
        <span class="hljs-keyword">if</span> (gffURL) { self.push({url: gffURL, uid: obj.uid}) }
      }
    }
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_download</span><span class="hljs-params">(db, term)</span> </span>{
  <span class="hljs-keyword">return</span> through.obj(transform)
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(obj, enc, next)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> prevTime = <span class="hljs-built_in">Date</span>.now()
    <span class="hljs-keyword">var</span> currTime
    <span class="hljs-keyword">var</span> chunkSizeMB = <span class="hljs-number">1</span>
    <span class="hljs-keyword">var</span> chunkSize = chunkSizeMB * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> <span class="hljs-comment">//bytes</span>
    <span class="hljs-keyword">var</span> folder = obj.uid + <span class="hljs-string">'/'</span>
    <span class="hljs-keyword">var</span> path = folder + obj.url.replace(<span class="hljs-regexp">/.*\//</span>, <span class="hljs-string">''</span>)

    mkdirp.sync(obj.uid)
    <span class="hljs-keyword">if</span> (!fs.existsSync(path)) {
      debug(<span class="hljs-string">'downloading'</span>, obj.url)
      dld(obj.url, folder, chunkSize)
      .on(<span class="hljs-string">'data'</span>, log)
      .on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        self.push(path)
        next()
      })
      .on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{ self.emit(<span class="hljs-string">'error'</span>, err) })
    }
    <span class="hljs-keyword">else</span> {
      self.push(path)
      next()
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span><span class="hljs-params">(position, size)</span> </span>{
      <span class="hljs-keyword">var</span> progress = (position * <span class="hljs-number">100</span> / size).toFixed(<span class="hljs-number">2</span>) + <span class="hljs-string">' %'</span>
      <span class="hljs-keyword">var</span> sizeMB = <span class="hljs-built_in">Math</span>.round(size / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>) + <span class="hljs-string">' MB'</span>
      currTime = <span class="hljs-built_in">Date</span>.now()
      <span class="hljs-keyword">var</span> diffTimeSec = (currTime - prevTime) / <span class="hljs-number">1000</span>
      prevTime = currTime
      <span class="hljs-keyword">var</span> speed =  (chunkSizeMB / diffTimeSec).toFixed(<span class="hljs-number">2</span>) + <span class="hljs-string">' MB/s'</span>
      <span class="hljs-keyword">var</span> log = <span class="hljs-string">'Downloading '</span> + path+<span class="hljs-string">' '</span>+ progress + <span class="hljs-string">' of '</span> + sizeMB + <span class="hljs-string">' at '</span> + speed
      self.push(log)
    }
  }
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_attachStandardEvents</span><span class="hljs-params">(stream, self, next)</span> </span>{
  stream
  .on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{ self.push(data) })
  .on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ next() })
  .on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{ self.emit(<span class="hljs-string">'error'</span>, err) })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_wait</span><span class="hljs-params">(ms)</span> </span>{
  <span class="hljs-keyword">return</span> through.obj(transform)
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span><span class="hljs-params">(obj, enc, next)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    setTimeout(pushObj, ms)
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pushObj</span><span class="hljs-params">()</span> </span>{
      self.push(obj)
      next()
    }
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
